<!-- Formulario para crear/editar un presupuesto -->
<div class="page">
  <div class="page-header">
    <h1>
      <!-- título cambia según si hay id y según el rol -->
      {{ id ? 'Editar presupuesto'
            : (auth.isUser() ? 'Enviar presupuesto' : 'Nuevo presupuesto') }}
    </h1>

    <!-- botón de volver: para user va a productos, para el resto vuelve al listado de presupuestos -->
    <a routerLink="/presupuestos" *ngIf="!auth.isUser()" class="btn-secondary">Volver</a>
    <a routerLink="/productos" *ngIf="auth.isUser()" class="btn-secondary">Volver</a>
  </div>

  <form [formGroup]="form" (ngSubmit)="save()">
    <div class="grid-2">
      <!-- campo de cliente solo para admin y empleado -->
      <div *ngIf="!auth.isUser()">
        <label for="cliente_id">Cliente ID</label>
        <input
          id="cliente_id"
          type="number"
          formControlName="cliente_id"
          min="1"
          placeholder="Ingrese el ID del cliente"
        />
      </div>

      <!-- estado del presupuesto solo editable por admin y empleado -->
      <div *ngIf="!auth.isUser()">
        <label for="estado">Estado</label>
        <select id="estado" formControlName="estado">
          <option value="borrador">Borrador</option>
          <option value="enviado">Enviado</option>
          <option value="aceptado">Aceptado</option>
          <option value="rechazado">Rechazado</option>
          <option value="vencido">Vencido</option>
        </select>
      </div>
    </div>

    <!-- notas las uso como datos de contacto del cliente -->
    <div>
      <label for="notas">Datos de contacto</label>
      <textarea
        id="notas"
        formControlName="notas"
        rows="3"
        placeholder="Ingresá aquí los datos de contacto del cliente"
      ></textarea>
    </div>

    <h3>Ítems del presupuesto</h3>

    <!-- listado dinámico de ítems del presupuesto -->
    <div formArrayName="items">
      <div
        class="item-row"
        *ngFor="let it of items.controls; let i = index"
        [formGroupName]="i"
      >
        <!-- intento completar por id de producto si lo cargo -->
        <input
          type="number"
          formControlName="producto_id"
          placeholder="ID del producto (opcional)"
          (blur)="autoCompletarPorId(i)"
        />
        <!-- también intento completar por nombre si el usuario no sabe el id -->
        <input
          type="text"
          formControlName="descripcion"
          placeholder="Descripción del producto o servicio"
          (blur)="autoCompletarPorNombre(i)"
        />
        <input
          type="number"
          min="1"
          formControlName="cantidad"
          placeholder="Cantidad"
        />
        <input
          type="number"
          min="0"
          step="0.01"
          formControlName="precio_unitario"
          placeholder="Precio unitario ($)"
        />
        <!-- quito un ítem del array -->
        <button
          type="button"
          class="btn-accion red"
          (click)="removeItem(i)"
        >
          Quitar
        </button>
      </div>
    </div>

    <!-- botón para agregar una nueva fila de ítem -->
    <button
      type="button"
      class="btn-accion blue"
      (click)="addItem()
    ">
      Agregar ítem
    </button>

    <!-- total calculado en vivo sumando los subtotales -->
    <div class="total-presupuesto mt">
      <span>Total estimado:</span>
      <strong>\${{ getTotal() | number:'1.2-2' }}</strong>
    </div>

    <!-- acciones principales: guardar o cancelar -->
    <div class="actions mt">
      <button
        class="btn-primary"
        type="submit"
        [disabled]="saving || form.invalid"
      >
        {{
          saving
            ? (auth.isUser() ? 'Enviando…' : 'Guardando…')
            : (auth.isUser() ? 'Enviar presupuesto' : 'Guardar presupuesto')
        }}
      </button>
      <button
        type="button"
        class="btn-secondary"
        (click)="cancel()"
      >
        Cancelar
      </button>
    </div>

    <!-- mensaje de error cuando la operación falla -->
    <div *ngIf="error" class="error mt">{{ error }}</div>
  </form>
</div>
